<!DOCTYPE html>
<html>
<head>
    <title>Export Test - Video Time Study</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; font-size: 14px; }
        .test-info { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .element-tag { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; color: white; }
    </style>
</head>
<body>
    <h1>üß™ Export Format Test</h1>
    <div class="test-info">
        <h3>Test Instructions:</h3>
        <ol>
            <li>Click <strong>"Export to CSV"</strong> and open the file in Excel</li>
            <li>Verify: UTF-8 BOM present (special chars display correctly)</li>
            <li>Verify: Quotes are properly escaped (descriptions with quotes)</li>
            <li>Verify: No # column (row numbers excluded)</li>
            <li>Verify: All text wrapped in quotes</li>
            <li>Click <strong>"Export to JSON"</strong> and open in text editor</li>
            <li>Verify: Properly formatted with 2-space indentation</li>
            <li>Verify: Valid JSON (paste into jsonlint.com to validate)</li>
        </ol>
    </div>

    <div>
        <button onclick="exportToCSV()">üì• Export to CSV</button>
        <button onclick="exportJSON()">üì• Export to JSON</button>
        <button onclick="runTests()">‚úÖ Run Tests</button>
    </div>

    <h2>Sample Data Table</h2>
    <table id="dataTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Timestamp</th>
                <th>Duration (s)</th>
                <th>Element</th>
                <th>Description</th>
                <th>Observations</th>
                <th>Rating</th>
                <th>Standard Time (s)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td>00:00:05</td>
                <td>3.5</td>
                <td><span class="element-tag" style="background:#FF6B6B">Assembly</span></td>
                <td>Pick part from bin "A" and place on fixture</td>
                <td>Smooth motion, no hesitation</td>
                <td>100%</td>
                <td>3.5</td>
            </tr>
            <tr>
                <td>2</td>
                <td>00:00:08.5</td>
                <td>2.8</td>
                <td><span class="element-tag" style="background:#4ECDC4">Inspection</span></td>
                <td>Visual check for "defects" and damage</td>
                <td>Thorough inspection</td>
                <td>95%</td>
                <td>2.9</td>
            </tr>
            <tr>
                <td>3</td>
                <td>00:00:11.3</td>
                <td>4.2</td>
                <td><span class="element-tag" style="background:#45B7D1">Tool Use</span></td>
                <td>Tighten screws with power driver</td>
                <td>Used correct torque setting</td>
                <td>105%</td>
                <td>4.0</td>
            </tr>
            <tr>
                <td>4</td>
                <td>00:00:15.5</td>
                <td>1.5</td>
                <td><span class="element-tag" style="background:#FFA07A">Material Handling</span></td>
                <td>Move completed assembly to QC area
Line 2 of description</td>
                <td>Efficient path</td>
                <td>110%</td>
                <td>1.4</td>
            </tr>
            <tr>
                <td>5</td>
                <td>00:00:17.0</td>
                <td>2.0</td>
                <td><span class="element-tag" style="background:#98D8C8">Documentation</span></td>
                <td>Record serial # and timestamp</td>
                <td>Clear handwriting</td>
                <td>100%</td>
                <td>2.0</td>
            </tr>
        </tbody>
    </table>

    <pre id="jsonData" style="display:none;">[{"timestamp":"00:00:05","duration":3.5,"element":"Assembly","description":"Pick part from bin \"A\" and place on fixture","observations":"Smooth motion, no hesitation","rating":"100%","standardTime":3.5},{"timestamp":"00:00:08.5","duration":2.8,"element":"Inspection","description":"Visual check for \"defects\" and damage","observations":"Thorough inspection","rating":"95%","standardTime":2.9},{"timestamp":"00:00:11.3","duration":4.2,"element":"Tool Use","description":"Tighten screws with power driver","observations":"Used correct torque setting","rating":"105%","standardTime":4.0},{"timestamp":"00:00:15.5","duration":1.5,"element":"Material Handling","description":"Move completed assembly to QC area\nLine 2 of description","observations":"Efficient path","rating":"110%","standardTime":1.4},{"timestamp":"00:00:17.0","duration":2.0,"element":"Documentation","description":"Record serial # and timestamp","observations":"Clear handwriting","rating":"100%","standardTime":2.0}]</pre>

    <div id="testResults" style="margin-top: 20px;"></div>

    <script>
        function exportJSON() {
            const jsonData = document.getElementById('jsonData').textContent.trim();
            const parsed = JSON.parse(jsonData);
            const formatted = JSON.stringify(parsed, null, 2);
            const blob = new Blob([formatted], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'time_study_test_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToCSV() {
            let csv = [];
            
            // Add BOM + headers
            csv.push('\uFEFF' + 'Timestamp,Duration (s),Element,Description,Observations,Rating,Standard Time (s)');
            
            // Add data rows from table body only (skip header)
            const table = document.getElementById('dataTable');
            const rows = table.tBodies[0].rows;
            
            for (let row of rows) {
                let rowData = [];
                // Skip first column (#) and get relevant data
                for (let i = 1; i < row.cells.length; i++) {
                    let cellText = row.cells[i].textContent.trim();
                    // Remove newlines and escape quotes
                    cellText = cellText.replace(/[\n\r]+/g, ' ').trim();
                    cellText = cellText.replace(/""/g, '""""');
                    rowData.push('"' + cellText + '"');
                }
                csv.push(rowData.join(','));
            }
            
            const blob = new Blob([csv.join('\r\n')], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'time_study_test_export.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function runTests() {
            const results = document.getElementById('testResults');
            let output = '<h3>Test Results:</h3><ul>';
            
            // Test 1: Check JSON is valid
            try {
                const jsonData = document.getElementById('jsonData').textContent.trim();
                const parsed = JSON.parse(jsonData);
                output += '<li class="success">‚úÖ JSON is valid and parseable</li>';
                output += '<li class="success">‚úÖ JSON contains ' + parsed.length + ' records</li>';
            } catch (e) {
                output += '<li style="color:red">‚ùå JSON parsing failed: ' + e.message + '</li>';
            }
            
            // Test 2: Check CSV structure
            const table = document.getElementById('dataTable');
            const rows = table.tBodies[0].rows;
            output += '<li class="success">‚úÖ Table has ' + rows.length + ' data rows</li>';
            
            // Test 3: Check for special characters
            let hasQuotes = false;
            let hasNewlines = false;
            for (let row of rows) {
                for (let i = 1; i < row.cells.length; i++) {
                    let text = row.cells[i].textContent;
                    if (text.includes('"')) hasQuotes = true;
                    if (text.includes('\n')) hasNewlines = true;
                }
            }
            
            if (hasQuotes) {
                output += '<li class="success">‚úÖ Data contains quotes (escape test enabled)</li>';
            }
            if (hasNewlines) {
                output += '<li class="success">‚úÖ Data contains newlines (removal test enabled)</li>';
            }
            
            // Test 4: Check column count
            const firstRow = rows[0];
            const columnCount = firstRow.cells.length - 1; // Exclude # column
            output += '<li class="success">‚úÖ Each row has ' + columnCount + ' data columns (excluding #)</li>';
            
            output += '</ul>';
            output += '<p><strong>Next Steps:</strong> Export the files and manually verify formatting in Excel and a text editor.</p>';
            
            results.innerHTML = output;
        }
    </script>
</body>
</html>
